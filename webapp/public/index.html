<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cybersecurity Customer Health Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #0d1117; color: #f0f6fc; }
        .header { background: #161b22; color: #f0f6fc; padding: 1rem; text-align: center; border-bottom: 1px solid #30363d; }
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; text-align: center; }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; justify-items: center; }
        .card { background: #161b22; border-radius: 8px; padding: 1.5rem; border: 1px solid #30363d; text-align: center; }
        .metric { text-align: center; margin-bottom: 1rem; }
        .metric-value { font-size: 2rem; font-weight: bold; color: #238636; cursor: pointer; transition: color 0.2s; }
        .metric-value:hover { color: #2ea043; }
        .metric-label { color: #8b949e; font-size: 0.9rem; }
        .status-critical { color: #f85149; }
        .status-high { color: #fb8500; }
        .status-good { color: #238636; }
        .chart-container { position: relative; height: 300px; }
        .tabs { display: flex; margin-bottom: 1rem; justify-content: center; }
        .tab { padding: 0.5rem 1rem; background: #21262d; border: 1px solid #30363d; color: #f0f6fc; cursor: pointer; }
        .tab.active { background: #238636; color: #f0f6fc; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .table { width: 100%; border-collapse: collapse; }
        .table th, .table td { padding: 0.5rem; text-align: left; border-bottom: 1px solid #30363d; color: #f0f6fc; }
        .table th { background: #21262d; }
        .details-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; }
        .details-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 2rem; max-width: 80%; max-height: 80%; overflow-y: auto; }
        .close-btn { float: right; background: none; border: none; color: #f0f6fc; font-size: 1.5rem; cursor: pointer; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Cybersecurity Customer Health Analytics Dashboard</h1>
    </div>

    <div class="container">
        <!-- Customer Selector -->
        <div class="card">
            <h3>Customer Selection</h3>
            <select id="customerSelect" onchange="updateCustomerMetrics()" style="padding: 0.5rem; background: #0d1117; color: #f0f6fc; border: 1px solid #30363d; border-radius: 4px; width: 300px;">
                <option value="all">All Customers (Average)</option>
            </select>
        </div>

        <!-- Customer Health Analysis -->
        <div class="card">
            <h3>Customer Health Analysis</h3>
            <p style="color: #8b949e; margin-bottom: 1.5rem;">Understand customer engagement and risk</p>
            <div class="dashboard">
                <div class="metric">
                    <div class="metric-value" id="sentiment" onclick="showDetails('sentiment')">-</div>
                    <div class="metric-label">Sentiment Score</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="incidentVolume" onclick="showDetails('incidentVolume')">-</div>
                    <div class="metric-label">Incident Volume</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="healthScore" onclick="showDetails('healthScore')">-</div>
                    <div class="metric-label">Health Score</div>
                </div>
            </div>
        </div>

        <!-- Support Efficiency -->
        <div class="card">
            <h3>Support Efficiency</h3>
            <p style="color: #8b949e; margin-bottom: 1.5rem;">Evaluate support workload & efficiency</p>
            <div class="dashboard">
                <div class="metric">
                    <div class="metric-value" id="ticketResolutionTime" onclick="showDetails('ticketResolutionTime')">-</div>
                    <div class="metric-label">Ticket Resolution Time</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="backlog" onclick="showDetails('backlog')">-</div>
                    <div class="metric-label">Backlog</div>
                </div>
            </div>
        </div>

        <!-- Incident Effectiveness -->
        <div class="card">
            <h3>Incident Effectiveness</h3>
            <p style="color: #8b949e; margin-bottom: 1.5rem;">Assess how security ops handle incidents</p>
            <div class="dashboard">
                <div class="metric">
                    <div class="metric-value" id="incidentResolutionTime" onclick="showDetails('incidentResolutionTime')">-</div>
                    <div class="metric-label">Resolution Time</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="slaAdherence" onclick="showDetails('slaAdherence')">-</div>
                    <div class="metric-label">SLA Adherence</div>
                </div>
            </div>
        </div>

        <!-- Detailed Analytics -->
        <div class="card" style="margin-top: 2rem;">
            <h3>Analytics Overview - All Customers</h3>
            <p style="color: #8b949e; margin-bottom: 1.5rem;">Comprehensive analytics across entire customer base</p>
            <div class="tabs">
                <button class="tab active" onclick="showTab('customer-journey')">Customer Journey</button>
                <button class="tab" onclick="showTab('security-analytics')">Security Analytics</button>
                <button class="tab" onclick="showTab('threat-intelligence')">Threat Intelligence</button>
            </div>

            <div id="customer-journey" class="tab-content active">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <div>
                        <h4>Customer Health Score Distribution</h4>
                        <div class="chart-container">
                            <canvas id="healthScoreChart"></canvas>
                        </div>
                    </div>
                    <div>
                        <h4>Support Ticket Trends</h4>
                        <div class="chart-container">
                            <canvas id="ticketTrendsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div id="security-analytics" class="tab-content">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <div>
                        <h4>Attack Patterns by Type</h4>
                        <div class="chart-container">
                            <canvas id="attackTypesChart"></canvas>
                        </div>
                    </div>
                    <div>
                        <h4>Incident Timeline</h4>
                        <div class="chart-container">
                            <canvas id="incidentTimelineChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div id="threat-intelligence" class="tab-content">
                <h4>Top Threat Sources</h4>
                <table class="table" id="threatTable">
                    <thead>
                        <tr>
                            <th>Source IP</th>
                            <th>Incidents</th>
                            <th>Customers Affected</th>
                            <th>Threat Level</th>
                            <th>Primary Attack</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- AI Chatbot -->
        <div class="card" style="margin-top: 2rem;">
            <h3>Ask questions about customer health, support efficiency, or security incidents</h3>
            
            <div id="chatMessages" style="height: 200px; overflow-y: auto; border: 1px solid #30363d; padding: 1rem; margin-bottom: 1rem; background: #0d1117;">
                <div style="color: #8b949e; font-style: italic;">Ask me anything about your data! Try: "Show me the highest risk customers" or "What's driving resolution times?"</div>
            </div>
            
            <div style="display: flex; gap: 0.5rem;">
                <input type="text" id="chatInput" placeholder="Ask about customer health, support metrics, or security patterns..." 
                       style="flex: 1; padding: 0.5rem; border: 1px solid #30363d; border-radius: 4px; background: #0d1117; color: #f0f6fc;" 
                       onkeypress="if(event.key==='Enter') sendMessage()">
                <button onclick="sendMessage()" style="padding: 0.5rem 1rem; background: #238636; color: #f0f6fc; border: none; border-radius: 4px; cursor: pointer;">Ask</button>
            </div>
        </div>
    </div>

    <!-- Details Modal -->
    <div id="detailsModal" class="details-modal">
        <div class="details-content">
            <button class="close-btn" onclick="closeDetails()">&times;</button>
            <h3 id="detailsTitle">Details</h3>
            <div id="detailsBody"></div>
        </div>
    </div>

    <script>
        Chart.register(ChartDataLabels);
        let dashboardData = {};
        let charts = {};

        async function loadDashboard() {
            try {
                const [dashboard, securityKPIs, ipAnalysis, attackPatterns] = await Promise.all([
                    fetch('/api/dashboard').then(r => r.json()),
                    fetch('/api/security-kpis').then(r => r.json()),
                    fetch('/api/ip-analysis').then(r => r.json()),
                    fetch('/api/attack-patterns').then(r => r.json())
                ]);

                dashboardData = { dashboard, securityKPIs, ipAnalysis, attackPatterns };
                updateMetrics();
                createCharts();
                updateThreatTable();
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        function updateMetrics() {
            const { dashboard, securityKPIs } = dashboardData;
            
            // Populate customer selector
            populateCustomerSelector();
            
            // Update customer-specific metrics (initially showing averages)
            updateCustomerMetrics();
        }
        
        async function populateCustomerSelector() {
            try {
                const customers = await fetch('/api/customers').then(r => r.json());
                const select = document.getElementById('customerSelect');
                
                customers.forEach(customer => {
                    const option = document.createElement('option');
                    option.value = customer.customer_id;
                    option.textContent = `Customer ${customer.customer_id}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading customers:', error);
            }
        }
        
        async function updateCustomerMetrics() {
            const selectedCustomer = document.getElementById('customerSelect').value;
            
            try {
                const [customers, tickets, incidents] = await Promise.all([
                    fetch('/api/customers').then(r => r.json()),
                    fetch('/api/tickets').then(r => r.json()),
                    fetch('/api/security-kpis').then(r => r.json())
                ]);
                
                let metrics;
                if (selectedCustomer === 'all') {
                    // Calculate averages for all customers
                    const validNPS = customers.filter(c => c.nps_score && c.nps_score !== 'NULL' && !isNaN(parseFloat(c.nps_score)));
                    const validIncidents = customers.filter(c => c.security_incidents_count && c.security_incidents_count !== 'NULL' && !isNaN(parseInt(c.security_incidents_count)));
                    const validTickets = customers.filter(c => c.support_tickets_count && c.support_tickets_count !== 'NULL' && !isNaN(parseInt(c.support_tickets_count)));
                    const validResolution = tickets.filter(t => t.resolution_time_hours && t.resolution_time_hours !== 'NULL' && !isNaN(parseFloat(t.resolution_time_hours)));
                    
                    metrics = {
                        sentiment: validNPS.length > 0 ? validNPS.reduce((sum, c) => sum + parseFloat(c.nps_score), 0) / validNPS.length : 7.2,
                        incidentVolume: validIncidents.length > 0 ? validIncidents.reduce((sum, c) => sum + parseInt(c.security_incidents_count), 0) / validIncidents.length : 2.5,
                        healthScore: 75, // Default health score
                        ticketResolutionTime: validResolution.length > 0 ? validResolution.reduce((sum, t) => sum + parseFloat(t.resolution_time_hours), 0) / validResolution.length : 16.7,
                        backlog: validTickets.length > 0 ? validTickets.reduce((sum, c) => sum + parseInt(c.support_tickets_count), 0) / validTickets.length : 3.2,
                        slaAdherence: 85
                    };
                } else {
                    // Get specific customer data
                    const customer = customers.find(c => c.customer_id === selectedCustomer);
                    const customerTickets = tickets.filter(t => t.customer_id === selectedCustomer);
                    
                    if (customer) {
                        const validCustomerTickets = customerTickets.filter(t => t.resolution_time_hours && t.resolution_time_hours !== 'NULL' && !isNaN(parseFloat(t.resolution_time_hours)));
                        
                        metrics = {
                            sentiment: customer.nps_score && !isNaN(parseFloat(customer.nps_score)) ? parseFloat(customer.nps_score) : 5.0,
                            incidentVolume: customer.security_incidents_count && !isNaN(parseInt(customer.security_incidents_count)) ? parseInt(customer.security_incidents_count) : 1,
                            healthScore: customer.health_score && !isNaN(parseFloat(customer.health_score)) ? parseFloat(customer.health_score) : 60,
                            ticketResolutionTime: validCustomerTickets.length > 0 ? validCustomerTickets.reduce((sum, t) => sum + parseFloat(t.resolution_time_hours), 0) / validCustomerTickets.length : 12.0,
                            backlog: customer.support_tickets_count && !isNaN(parseInt(customer.support_tickets_count)) ? parseInt(customer.support_tickets_count) : 2,
                            slaAdherence: 80
                        };
                    }
                }
                
                // Update display
                if (metrics) {
                    document.getElementById('sentiment').textContent = metrics.sentiment.toFixed(1);
                    document.getElementById('incidentVolume').textContent = selectedCustomer === 'all' ? metrics.incidentVolume.toFixed(1) : metrics.incidentVolume;
                    document.getElementById('healthScore').textContent = metrics.healthScore.toFixed(1) + '%';
                    document.getElementById('ticketResolutionTime').textContent = metrics.ticketResolutionTime.toFixed(1) + 'h';
                    document.getElementById('backlog').textContent = selectedCustomer === 'all' ? metrics.backlog.toFixed(1) : metrics.backlog;
                    document.getElementById('incidentResolutionTime').textContent = '2.5h';
                    document.getElementById('slaAdherence').textContent = metrics.slaAdherence + '%';
                }
                
            } catch (error) {
                console.error('Error updating customer metrics:', error);
            }
        }

        function createCharts() {
            const { dashboard, attackPatterns } = dashboardData;

            // Customer Health Score Chart
            if (charts.healthScore) charts.healthScore.destroy();
            charts.healthScore = new Chart(document.getElementById('healthScoreChart'), {
                type: 'doughnut',
                data: {
                    labels: ['High Risk', 'Medium Risk', 'Low Risk'],
                    datasets: [{
                        data: [
                            dashboard.highRiskCustomers,
                            Math.floor((dashboard.totalCustomers - dashboard.highRiskCustomers) * 0.3),
                            dashboard.totalCustomers - dashboard.highRiskCustomers - Math.floor((dashboard.totalCustomers - dashboard.highRiskCustomers) * 0.3)
                        ],
                        backgroundColor: ['#f85149', '#fb8500', '#238636']
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: {
                        datalabels: {
                            color: '#f0f6fc',
                            font: { weight: 'bold' },
                            formatter: (value) => value
                        }
                    }
                }
            });

            // Support Ticket Trends Chart
            if (charts.ticketTrends) charts.ticketTrends.destroy();
            charts.ticketTrends = new Chart(document.getElementById('ticketTrendsChart'), {
                type: 'bar',
                data: {
                    labels: ['Resolved', 'Escalated', 'Pending'],
                    datasets: [{
                        label: 'Tickets',
                        data: [
                            dashboard.resolvedTickets,
                            dashboard.escalatedTickets,
                            dashboard.totalTickets - dashboard.resolvedTickets
                        ],
                        backgroundColor: ['#238636', '#fb8500', '#1f6feb']
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: {
                        datalabels: {
                            color: '#f0f6fc',
                            font: { weight: 'bold' },
                            formatter: (value) => value
                        }
                    }
                }
            });

            // Attack Types Chart
            if (charts.attackTypes) charts.attackTypes.destroy();
            charts.attackTypes = new Chart(document.getElementById('attackTypesChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(attackPatterns.byType),
                    datasets: [{
                        data: Object.values(attackPatterns.byType),
                        backgroundColor: ['#f85149', '#fb8500', '#1f6feb']
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: {
                        datalabels: {
                            color: '#f0f6fc',
                            font: { weight: 'bold' },
                            formatter: (value) => value
                        }
                    }
                }
            });

            // Incident Timeline Chart
            if (charts.timeline) charts.timeline.destroy();
            charts.timeline = new Chart(document.getElementById('incidentTimelineChart'), {
                type: 'line',
                data: {
                    labels: attackPatterns.byHour.map((_, i) => i + ':00'),
                    datasets: [{
                        label: 'Incidents by Hour',
                        data: attackPatterns.byHour,
                        borderColor: '#238636',
                        backgroundColor: '#238636',
                        fill: false
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: {
                        datalabels: {
                            color: '#f0f6fc',
                            font: { weight: 'bold' },
                            formatter: (value) => value
                        }
                    }
                }
            });
        }

        function updateThreatTable() {
            const { ipAnalysis } = dashboardData;
            const tbody = document.querySelector('#threatTable tbody');
            tbody.innerHTML = '';

            ipAnalysis.slice(0, 10).forEach(ip => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${ip.ip}</td>
                    <td>${ip.incidents}</td>
                    <td>${ip.customers}</td>
                    <td><span class="status-${ip.threatLevel === 'High Risk' ? 'critical' : 'high'}">${ip.threatLevel}</span></td>
                    <td>${ip.attackTypes[0] || 'N/A'}</td>
                `;
            });
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        function showDetails(type) {
            const modal = document.getElementById('detailsModal');
            const title = document.getElementById('detailsTitle');
            const body = document.getElementById('detailsBody');
            
            const details = {
                sentiment: { title: 'Sentiment Score', content: '<p>Customer satisfaction score based on NPS feedback</p>' },
                incidentVolume: { title: 'Incident Volume', content: '<p>Average number of security incidents per customer</p>' },
                healthScore: { title: 'Health Score', content: '<p>Overall customer health percentage based on multiple factors</p>' },
                ticketResolutionTime: { title: 'Ticket Resolution Time', content: '<p>Average time to resolve support tickets</p>' },
                backlog: { title: 'Support Backlog', content: '<p>Average number of open support tickets per customer</p>' },
                incidentResolutionTime: { title: 'Incident Resolution Time', content: '<p>Average time to resolve security incidents</p>' },
                slaAdherence: { title: 'SLA Adherence', content: '<p>Percentage of incidents resolved within SLA timeframes</p>' }
            };
            
            if (details[type]) {
                title.textContent = details[type].title;
                body.innerHTML = details[type].content;
                modal.style.display = 'block';
            }
        }
        
        function closeDetails() {
            document.getElementById('detailsModal').style.display = 'none';
        }
        
        // Close modal on outside click
        window.onclick = function(event) {
            const modal = document.getElementById('detailsModal');
            if (event.target === modal) {
                closeDetails();
            }
        }
        
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const messages = document.getElementById('chatMessages');
            const question = input.value.trim();
            
            if (!question) return;
            
            // Add user message
            messages.innerHTML += `<div style="margin-bottom: 1rem; text-align: right;"><strong>You:</strong> ${question}</div>`;
            input.value = '';
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                const responseText = data.response?.summary || data.response || 'No response available';
                messages.innerHTML += `<div style="margin-bottom: 1rem;"><strong>Assistant:</strong> ${responseText}</div>`;
                messages.scrollTop = messages.scrollHeight;
            } catch (error) {
                console.error('Chat error:', error);
                messages.innerHTML += `<div style="margin-bottom: 1rem; color: #f85149;"><strong>Error:</strong> ${error.message}</div>`;
            }
        }

        // Load dashboard on page load
        loadDashboard();
    </script>
</body>
</html>